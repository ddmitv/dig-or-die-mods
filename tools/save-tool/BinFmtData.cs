
using SaveTool.Data;
using System;
using System.Collections.Generic;
using System.IO;

namespace SaveTool;

// writes values in .NET BinaryFormatter serialization format without using the unsafe BinaryFormatter implementation.
// uses hardcoded serialization headers to produce compatible binary output for simple types.
public static class BinFmtData {
    #region BinaryFormatter magic constants
    private const byte messageEndTag = 0x0B;

    private static readonly byte[] intMagic = {
        0x00, 0x01, 0x00, 0x00, 0x00, 0xFF, 0xFF, 0xFF, 0xFF, 0x01, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
        0x00, 0x04, 0x01, 0x00, 0x00, 0x00, 0x0C, 0x53, 0x79, 0x73, 0x74, 0x65, 0x6D, 0x2E, 0x49, 0x6E,
        0x74, 0x33, 0x32, 0x01, 0x00, 0x00, 0x00, 0x07, 0x6D, 0x5F, 0x76, 0x61, 0x6C, 0x75, 0x65, 0x00,
        0x08,
    };
    private static readonly byte[] boolMagic = {
        0x00, 0x01, 0x00, 0x00, 0x00, 0xFF, 0xFF, 0xFF, 0xFF, 0x01, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
        0x00, 0x04, 0x01, 0x00, 0x00, 0x00, 0x0E, 0x53, 0x79, 0x73, 0x74, 0x65, 0x6D, 0x2E, 0x42, 0x6F,
        0x6F, 0x6C, 0x65, 0x61, 0x6E, 0x01, 0x00, 0x00, 0x00, 0x07, 0x6D, 0x5F, 0x76, 0x61, 0x6C, 0x75,
        0x65, 0x00, 0x01,
    };
    private static readonly byte[] doubleMagic = {
        0x00, 0x01, 0x00, 0x00, 0x00, 0xFF, 0xFF, 0xFF, 0xFF, 0x01, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
        0x00, 0x04, 0x01, 0x00, 0x00, 0x00, 0x0D, 0x53, 0x79, 0x73, 0x74, 0x65, 0x6D, 0x2E, 0x44, 0x6F,
        0x75, 0x62, 0x6C, 0x65, 0x01, 0x00, 0x00, 0x00, 0x07, 0x6D, 0x5F, 0x76, 0x61, 0x6C, 0x75, 0x65,
        0x00, 0x06,
    };
    private static readonly byte[] floatMagic = {
        0x00, 0x01, 0x00, 0x00, 0x00, 0xFF, 0xFF, 0xFF, 0xFF, 0x01, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
        0x00, 0x04, 0x01, 0x00, 0x00, 0x00, 0x0D, 0x53, 0x79, 0x73, 0x74, 0x65, 0x6D, 0x2E, 0x53, 0x69,
        0x6E, 0x67, 0x6C, 0x65, 0x01, 0x00, 0x00, 0x00, 0x07, 0x6D, 0x5F, 0x76, 0x61, 0x6C, 0x75, 0x65,
        0x00, 0x0B,
    };
    private static readonly byte[] ushort16Magic = {
        0x00, 0x01, 0x00, 0x00, 0x00, 0xFF, 0xFF, 0xFF, 0xFF, 0x01, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
        0x00, 0x04, 0x01, 0x00, 0x00, 0x00, 0x0D, 0x53, 0x79, 0x73, 0x74, 0x65, 0x6D, 0x2E, 0x55, 0x49,
        0x6E, 0x74, 0x31, 0x36, 0x01, 0x00, 0x00, 0x00, 0x07, 0x6D, 0x5F, 0x76, 0x61, 0x6C, 0x75, 0x65,
        0x00, 0x0E,
    };
    private static readonly byte[] int2Magic = {
        0x00, 0x01, 0x00, 0x00, 0x00, 0xFF, 0xFF, 0xFF, 0xFF, 0x01, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
        0x00, 0x0C, 0x02, 0x00, 0x00, 0x00, 0x0F, 0x41, 0x73, 0x73, 0x65, 0x6D, 0x62, 0x6C, 0x79, 0x2D,
        0x43, 0x53, 0x68, 0x61, 0x72, 0x70, 0x05, 0x01, 0x00, 0x00, 0x00, 0x04, 0x69, 0x6E, 0x74, 0x32,
        0x02, 0x00, 0x00, 0x00, 0x01, 0x78, 0x01, 0x79, 0x00, 0x00, 0x08, 0x08, 0x02, 0x00, 0x00, 0x00,
    };
    private static readonly byte[] vector2Magic = {
        0x00, 0x01, 0x00, 0x00, 0x00, 0xFF, 0xFF, 0xFF, 0xFF, 0x01, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
        0x00, 0x0C, 0x02, 0x00, 0x00, 0x00, 0x0B, 0x55, 0x6E, 0x69, 0x74, 0x79, 0x45, 0x6E, 0x67, 0x69,
        0x6E, 0x65, 0x05, 0x01, 0x00, 0x00, 0x00, 0x13, 0x55, 0x6E, 0x69, 0x74, 0x79, 0x45, 0x6E, 0x67,
        0x69, 0x6E, 0x65, 0x2E, 0x56, 0x65, 0x63, 0x74, 0x6F, 0x72, 0x32, 0x02, 0x00, 0x00, 0x00, 0x01,
        0x78, 0x01, 0x79, 0x00, 0x00, 0x0B, 0x0B, 0x02, 0x00, 0x00, 0x00,
    };
    private static readonly byte[] rocketStepMagic = {
        0x00, 0x01, 0x00, 0x00, 0x00, 0xFF, 0xFF, 0xFF, 0xFF, 0x01, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
        0x00, 0x0C, 0x02, 0x00, 0x00, 0x00, 0x0F, 0x41, 0x73, 0x73, 0x65, 0x6D, 0x62, 0x6C, 0x79, 0x2D,
        0x43, 0x53, 0x68, 0x61, 0x72, 0x70, 0x05, 0x01, 0x00, 0x00, 0x00, 0x10, 0x47, 0x56, 0x61, 0x72,
        0x73, 0x2B, 0x52, 0x6F, 0x63, 0x6B, 0x65, 0x74, 0x53, 0x74, 0x65, 0x70, 0x01, 0x00, 0x00, 0x00,
        0x07, 0x76, 0x61, 0x6C, 0x75, 0x65, 0x5F, 0x5F, 0x00, 0x08, 0x02, 0x00, 0x00, 0x00,
    };
    private static readonly byte[] stringListMagic1 = {
        0x00, 0x01, 0x00, 0x00, 0x00, 0xFF, 0xFF, 0xFF, 0xFF, 0x01, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
        0x00, 0x04, 0x01, 0x00, 0x00, 0x00, 0x7F, 0x53, 0x79, 0x73, 0x74, 0x65, 0x6D, 0x2E, 0x43, 0x6F,
        0x6C, 0x6C, 0x65, 0x63, 0x74, 0x69, 0x6F, 0x6E, 0x73, 0x2E, 0x47, 0x65, 0x6E, 0x65, 0x72, 0x69,
        0x63, 0x2E, 0x4C, 0x69, 0x73, 0x74, 0x60, 0x31, 0x5B, 0x5B, 0x53, 0x79, 0x73, 0x74, 0x65, 0x6D,
        0x2E, 0x53, 0x74, 0x72, 0x69, 0x6E, 0x67, 0x2C, 0x20, 0x6D, 0x73, 0x63, 0x6F, 0x72, 0x6C, 0x69,
        0x62, 0x2C, 0x20, 0x56, 0x65, 0x72, 0x73, 0x69, 0x6F, 0x6E, 0x3D, 0x32, 0x2E, 0x30, 0x2E, 0x35,
        0x2E, 0x30, 0x2C, 0x20, 0x43, 0x75, 0x6C, 0x74, 0x75, 0x72, 0x65, 0x3D, 0x6E, 0x65, 0x75, 0x74,
        0x72, 0x61, 0x6C, 0x2C, 0x20, 0x50, 0x75, 0x62, 0x6C, 0x69, 0x63, 0x4B, 0x65, 0x79, 0x54, 0x6F,
        0x6B, 0x65, 0x6E, 0x3D, 0x37, 0x63, 0x65, 0x63, 0x38, 0x35, 0x64, 0x37, 0x62, 0x65, 0x61, 0x37,
        0x37, 0x39, 0x38, 0x65, 0x5D, 0x5D, 0x03, 0x00, 0x00, 0x00, 0x06, 0x5F, 0x69, 0x74, 0x65, 0x6D,
        0x73, 0x05, 0x5F, 0x73, 0x69, 0x7A, 0x65, 0x08, 0x5F, 0x76, 0x65, 0x72, 0x73, 0x69, 0x6F, 0x6E,
        0x06, 0x00, 0x00, 0x08, 0x08, 0x09, 0x02, 0x00, 0x00, 0x00,
    };
    private static readonly byte[] stringListMagic2 = {
        0x0A, 0x00, 0x00, 0x00, 0x11, 0x02, 0x00, 0x00, 0x00,
    };
    private static readonly byte[] stringMagic = {
        0x00, 0x01, 0x00, 0x00, 0x00, 0xFF, 0xFF, 0xFF, 0xFF, 0x01, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
        0x00, 0x06, 0x01, 0x00, 0x00, 0x00,
    };
    private static readonly byte[] ulongMagic = {
        0x00, 0x01, 0x00, 0x00, 0x00, 0xFF, 0xFF, 0xFF, 0xFF, 0x01, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
        0x00, 0x04, 0x01, 0x00, 0x00, 0x00, 0x0D, 0x53, 0x79, 0x73, 0x74, 0x65, 0x6D, 0x2E, 0x55, 0x49,
        0x6E, 0x74, 0x36, 0x34, 0x01, 0x00, 0x00, 0x00, 0x07, 0x6D, 0x5F, 0x76, 0x61, 0x6C, 0x75, 0x65,
        0x00, 0x10,
    };
    #endregion

    public static void WriteInt(BinaryWriter writer, int value) {
        writer.Write(intMagic);
        writer.Write(value);
        writer.Write(messageEndTag);
    }
    public static void WriteBool(BinaryWriter writer, bool value) {
        writer.Write(boolMagic);
        writer.Write(value);
        writer.Write(messageEndTag);
    }
    public static void WriteDouble(BinaryWriter writer, double value) {
        writer.Write(doubleMagic);
        writer.Write(value);
        writer.Write(messageEndTag);
    }
    public static void WriteFloat(BinaryWriter writer, float value) {
        writer.Write(floatMagic);
        writer.Write(value);
        writer.Write(messageEndTag);
    }
    public static void WriteUShort(BinaryWriter writer, ushort value) {
        writer.Write(ushort16Magic);
        writer.Write(value);
        writer.Write(messageEndTag);
    }
    public static void WriteInt2(BinaryWriter writer, int2 value) {
        writer.Write(int2Magic);
        writer.Write((int)value.x);
        writer.Write((int)value.y);
        writer.Write(messageEndTag);
    }
    public static void WriteVector2(BinaryWriter writer, Vector2 value) {
        writer.Write(vector2Magic);
        writer.Write((float)value.x);
        writer.Write((float)value.y);
        writer.Write(messageEndTag);
    }
    public static void WriteRocketStep(BinaryWriter writer, Vars.RocketStep rocketStepEnum) {
        writer.Write(rocketStepMagic);
        writer.Write((int)rocketStepEnum);
        writer.Write(messageEndTag);
    }
    public static void WriteStringList(BinaryWriter writer, List<string> strings) {
        writer.Write(stringListMagic1);
        writer.Write((int)strings.Count); // list length
        writer.Write(stringListMagic2);
        writer.Write((int)strings.Count); // list capacity

        const byte recordTypeString = 0x06;

        int recordObjectId = 3;
        foreach (string str in strings) {
            writer.Write(recordTypeString);
            writer.Write(recordObjectId);
            writer.Write(str);

            recordObjectId += 1;
        }
        // no need for null fillers because length=capacity
        writer.Write(messageEndTag);
    }
    public static void WriteString(BinaryWriter writer, string value) {
        writer.Write(stringMagic);
        writer.Write(value);
        writer.Write(messageEndTag);
    }
    public static void WriteULong(BinaryWriter writer, ulong value) {
        writer.Write(ulongMagic);
        writer.Write(value);
        writer.Write(messageEndTag);
    }
}
